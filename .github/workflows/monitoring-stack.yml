name: Deploy Monitoring Stack to EKS

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "EKS Cluster name"
        required: true
        type: string
      cluster_region:
        description: "AWS region of the cluster (e.g. us-east-1)"
        required: true
        type: string

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest

    env:
      CLUSTER_NAME: ${{ inputs.cluster_name }}
      CLUSTER_REGION: ${{ inputs.cluster_region }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.CLUSTER_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.16.2"

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name "${CLUSTER_NAME}" \
            --region "${CLUSTER_REGION}"

      - name: Verify cluster access
        run: |
          kubectl get nodes
          kubectl get ns

      - name: Verify metrics-server (optional)
        run: |
          echo "Checking metrics API..."
          kubectl get pods -n kube-system | grep -i metrics || echo "metrics-server pod not found"
          kubectl top nodes || echo "kubectl top failed (metrics-server may not be ready yet)"

      # ----------------------------
      # Install Prometheus + Grafana via kube-prometheus-stack
      # ----------------------------
      - name: Add prometheus-community Helm repo
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Install / upgrade kube-prometheus-stack
        run: |
          helm upgrade --install monitoring-stack prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --create-namespace \
            --set grafana.enabled=true \
            --set grafana.adminUser=admin \
            --set grafana.adminPassword=admin1234 \
            --set grafana.service.type=LoadBalancer \
            --set grafana.service.port=80 \
            --set grafana.service.targetPort=3000 \
            --set prometheus.prometheusSpec.retention=15d

      - name: Show monitoring services
        run: |
          echo "---- monitoring namespace services ----"
          kubectl get svc -n monitoring
      - name: Deploy diabetes-api monitoring objects
        run: |
          echo "Applying diabetic-api monitoring objects..."
          kubectl apply -f diabetic-api-monitoring/servicemonitor.yaml
          kubectl apply -f diabetic-api-monitoring/prometheusrule.yaml

      - name: Check diabetes-api monitoring resources
        run: |
          echo "---- diabetes-api deployment (existing) ----"
          kubectl get deploy diabetes-api -n default || echo "Deployment diabetes-api not found in default namespace"
          echo "---- ServiceMonitor & PrometheusRule ----"
          kubectl get servicemonitor,prometheusrule -n monitoring | grep diabetic || true