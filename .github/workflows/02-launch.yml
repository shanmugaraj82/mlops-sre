name: 02 - Jenkins EC2 - Launch Instance

on:
  workflow_dispatch:
    inputs:
      subnet_id:
        description: "SubnetId (from 01 workflow output)"
        required: true
      sg_id:
        description: "SecurityGroupId (from 01 workflow output)"
        required: true
      instance_type:
        description: "EC2 instance type"
        required: false
        default: "t3a.large"

jobs:
  launch:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Launch EC2 instance for Jenkins
        id: ec2
        run: |
          AMI_ID="ami-0c02fb55956c7d316"   # Amazon Linux 2 us-east-1 (verify/update if needed)
          INSTANCE_TYPE="${{ inputs.instance_type }}"
          SUBNET_ID="${{ inputs.subnet_id }}"
          SG_ID="${{ inputs.sg_id }}"
          KEY_NAME="${{ secrets.EC2_KEY_PAIR_NAME }}"

          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id "$AMI_ID" \
            --instance-type "$INSTANCE_TYPE" \
            --subnet-id "$SUBNET_ID" \
            --security-group-ids "$SG_ID" \
            --associate-public-ip-address \
            --key-name "$KEY_NAME" \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=jenkins-server}]' \
            --query "Instances[0].InstanceId" --output text)

          aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"

          PUBLIC_DNS=$(aws ec2 describe-instances --instance-ids "$INSTANCE_ID" \
            --query "Reservations[0].Instances[0].PublicDnsName" --output text)

          echo "instance_id=$INSTANCE_ID" >> "$GITHUB_OUTPUT"
          echo "public_dns=$PUBLIC_DNS" >> "$GITHUB_OUTPUT"

      - name: Print outputs (copy these)
        run: |
          echo "INSTANCE_ID=${{ steps.ec2.outputs.instance_id }}"
          echo "PUBLIC_DNS=${{ steps.ec2.outputs.public_dns }}"
