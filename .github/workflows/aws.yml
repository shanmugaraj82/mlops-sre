name: Deploy Jenkins EC2

on:
  workflow_dispatch: {}   # Run manually from GitHub Actions UI

jobs:
  deploy-jenkins-ec2:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Configure AWS using GitHub Secrets (writes to ~/.aws/credentials)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Find default VPC
        id: vpc
        run: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=isDefault,Values=true" \
            --query "Vpcs[0].VpcId" \
            --output text)

          if [ "$VPC_ID" = "None" ] || [ -z "$VPC_ID" ]; then
            echo "No default VPC found in region ${AWS_REGION}"
            exit 1
          fi

          echo "Default VPC: ${VPC_ID}"
          echo "vpc_id=${VPC_ID}" >> "$GITHUB_OUTPUT"

      - name: Create security group for Jenkins (if needed)
        id: sg
        run: |
          SG_NAME="jenkins-sg"
          VPC_ID="${{ steps.vpc.outputs.vpc_id }}"

          # Check if SG exists
          EXISTING_SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=${SG_NAME}" "Name=vpc-id,Values=${VPC_ID}" \
            --query "SecurityGroups[0].GroupId" \
            --output text 2>/dev/null || true)

          if [ "$EXISTING_SG_ID" = "None" ] || [ -z "$EXISTING_SG_ID" ]; then
            echo "Creating new security group ${SG_NAME} in VPC ${VPC_ID}"
            SG_ID=$(aws ec2 create-security-group \
              --group-name "${SG_NAME}" \
              --description "Security group for Jenkins server" \
              --vpc-id "${VPC_ID}" \
              --query "GroupId" \
              --output text)

            # Allow SSH (22) and Jenkins (8080) from anywhere (tighten this in real use)
            aws ec2 authorize-security-group-ingress \
              --group-id "${SG_ID}" \
              --ip-permissions '[
                {"IpProtocol": "tcp", "FromPort": 22, "ToPort": 22, "IpRanges": [{"CidrIp": "0.0.0.0/0"}]},
                {"IpProtocol": "tcp", "FromPort": 8080, "ToPort": 8080, "IpRanges": [{"CidrIp": "0.0.0.0/0"}]}
              ]'
          else
            echo "Using existing security group ${EXISTING_SG_ID}"
            SG_ID="${EXISTING_SG_ID}"
          fi

          echo "sg_id=${SG_ID}" >> "$GITHUB_OUTPUT"

      - name: Find a default subnet in the default VPC
        id: subnet
        run: |
          VPC_ID="${{ steps.vpc.outputs.vpc_id }}"
          SUBNET_ID=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=${VPC_ID}" "Name=default-for-az,Values=true" \
            --query "Subnets[0].SubnetId" \
            --output text)

          if [ "$SUBNET_ID" = "None" ] || [ -z "$SUBNET_ID" ]; then
            echo "No default subnet found in default VPC ${VPC_ID}"
            exit 1
          fi

          echo "Using default subnet: ${SUBNET_ID}"
          echo "subnet_id=${SUBNET_ID}" >> "$GITHUB_OUTPUT"

      - name: Launch EC2 instance for Jenkins
        id: ec2
        run: |
          # Amazon Linux 2 AMI for us-east-1 (x86_64)
          AMI_ID="ami-0c02fb55956c7d316"

          INSTANCE_TYPE="t3.small"
          SUBNET_ID="${{ steps.subnet.outputs.subnet_id }}"
          SG_ID="${{ steps.sg.outputs.sg_id }}"
          KEY_NAME="${{ secrets.EC2_KEY_PAIR_NAME }}"

          echo "Launching EC2 instance in subnet ${SUBNET_ID} with SG ${SG_ID} and key pair ${KEY_NAME}..."

          INSTANCE_ID=$(aws ec2.run-instances \
            --image-id "${AMI_ID}" \
            --instance-type "${INSTANCE_TYPE}" \
            --subnet-id "${SUBNET_ID}" \
            --security-group-ids "${SG_ID}" \
            --associate-public-ip-address \
            --key-name "${KEY_NAME}" \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=jenkins-server}]' \
            --query "Instances[0].InstanceId" \
            --output text)

          echo "Created instance: ${INSTANCE_ID}"

          # Wait until instance is running
          aws ec2 wait instance-running --instance-ids "${INSTANCE_ID}"

          # Get public DNS
          PUBLIC_DNS=$(aws ec2 describe-instances \
            --instance-ids "${INSTANCE_ID}" \
            --query "Reservations[0].Instances[0].PublicDnsName" \
            --output text)

          echo "instance_id=${INSTANCE_ID}" >> "$GITHUB_OUTPUT"
          echo "public_dns=${PUBLIC_DNS}" >> "$GITHUB_OUTPUT"

      - name: Output instance info
        run: |
          echo "EC2 Instance ID: ${{ steps.ec2.outputs.instance_id }}"
          echo "Public DNS: ${{ steps.ec2.outputs.public_dns }}"

      # Setup SSH key on the runner
      - name: Setup SSH key for EC2 access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/jenkins-ec2-key
          chmod 600 ~/.ssh/jenkins-ec2-key
          printf "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null\n" >> ~/.ssh/config

      - name: Wait for SSH (port 22) to be reachable
        run: |
          PUBLIC_DNS="${{ steps.ec2.outputs.public_dns }}"
          echo "Waiting for SSH on ${PUBLIC_DNS}:22..."

          for i in {1..30}; do
            echo "Attempt $i: checking SSH..."
            if timeout 5 bash -c "echo >/dev/tcp/${PUBLIC_DNS}/22" 2>/dev/null; then
              echo "SSH is reachable."
              exit 0
            fi
            echo "SSH not ready yet, sleeping 10 seconds..."
            sleep 10
          done

          echo "SSH not reachable after multiple attempts."
          exit 1

      - name: Install Jenkins on EC2 via SSH
        run: |
          PUBLIC_DNS="${{ steps.ec2.outputs.public_dns }}"

          echo "Installing Jenkins on ${PUBLIC_DNS} via SSH..."
          ssh -i ~/.ssh/jenkins-ec2-key ec2-user@"${PUBLIC_DNS}" << 'EOF'
          set -e

          # Update system
          sudo yum update -y

          # Install Java (required by Jenkins)
          sudo amazon-linux-extras install java-openjdk11 -y || sudo yum install -y java-11-openjdk

          # Add Jenkins repo and key
          curl -fsSL https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key | sudo tee \
            /etc/pki/rpm-gpg/RPM-GPG-KEY-jenkins.io-2023 >/dev/null

          sudo bash -c 'cat > /etc/yum.repos.d/jenkins.repo << "EOR"
          [jenkins]
          name=Jenkins-stable
          baseurl=https://pkg.jenkins.io/redhat-stable
          gpgcheck=1
          gpgkey=https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
          EOR'

          # Install Jenkins
          sudo yum install -y jenkins

          # Enable and start Jenkins
          sudo systemctl enable jenkins
          sudo systemctl start jenkins

          # Optional: open firewall for port 8080 if firewalld is present
          if command -v firewall-cmd &> /dev/null; then
            sudo firewall-cmd --permanent --add-port=8080/tcp || true
            sudo firewall-cmd --reload || true
          fi
          EOF

      - name: Output Jenkins URL
        run: |
          echo "Jenkins should be accessible (after Jenkins finishes starting) at:"
          echo "  http://${{ steps.ec2.outputs.public_dns }}:8080"

      - name: Fetch Jenkins initial admin password
        run: |
          PUBLIC_DNS="${{ steps.ec2.outputs.public_dns }}"

          echo "Waiting for Jenkins to complete initial setup and generate the admin password..."

          # Poll up to ~10 minutes (20 * 30s)
          for i in {1..20}; do
            echo "Attempt $i: checking for /var/lib/jenkins/secrets/initialAdminPassword..."

            if ssh -i ~/.ssh/jenkins-ec2-key ec2-user@"${PUBLIC_DNS}" "test -f /var/lib/jenkins/secrets/initialAdminPassword"; then
              echo "Password file found. Fetching..."

              ssh -i ~/.ssh/jenkins-ec2-key ec2-user@"${PUBLIC_DNS}" \
                "sudo cat /var/lib/jenkins/secrets/initialAdminPassword" > jenkins_admin_password.txt

              echo "------------------------"
              echo "Jenkins initial admin password:"
              cat jenkins_admin_password.txt
              echo "------------------------"

              exit 0
            fi

            echo "Not ready yet, waiting 30 seconds..."
            sleep 30
          done

          echo "initialAdminPassword file not found after waiting. Dumping Jenkins status and logs..."

          ssh -i ~/.ssh/jenkins-ec2-key ec2-user@"${PUBLIC_DNS}" \
            "sudo systemctl status jenkins --no-pager || true"

          ssh -i ~/.ssh/jenkins-ec2-key ec2-user@"${PUBLIC_DNS}" \
            "sudo journalctl -u jenkins --no-pager | tail -n 50 || true"

          exit 1
